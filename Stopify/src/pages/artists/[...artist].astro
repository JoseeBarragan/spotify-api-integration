---
export const prerender = false;
import MainLayout from "@layouts/mainLayout.astro";
import ArtistHeader from "@components/Artists/ArtistHeader.astro"
import { getSecret } from "astro:env/server";
import { GetPaletteHex} from "@/utils/paletteUtils"
import ArtistActionsTracks from "@/components/Artists/ArtistActionsTracks.tsx"
import ArtistAlbums from "@components/Artists/ArtistAlbum"
import refreshToken from "@/services/refreshToken";
import type { Palette } from "@/types/VibrantTypes";
import ArtistDiscography from "@/components/Artists/ArtistDiscography.astro";


const FRONTEND_URL = getSecret("FRONTEND_URL")
const { artist } = Astro.params

const [artistData, artistTopTracks, artistAlbums] = await Promise.all([
    fetch(`${FRONTEND_URL}/api/spotify/artists/${artist}`).then(r => r.json()),
    fetch(`${FRONTEND_URL}/api/spotify/artists/${artist}/top-tracks`).then(r => r.json()),
    fetch(`${FRONTEND_URL}/api/spotify/artists/${artist}/albums?include_groups=single,album`).then(r => r.json())
])

if (artistData.expired || artistData.status === 401) {
    await refreshToken()
}
const imgUrl = artistAlbums?.items[0]?.images.at(0)?.url ?? null

let palette: {colors: Palette} | null = null

if (imgUrl) {
    palette = await (await fetch(`${FRONTEND_URL}/api/GradientColors/${imgUrl}`)).json()
}
const HexPalette = GetPaletteHex(palette?.colors)

---
<MainLayout>
    <div class="h-fit w-full relative z-0 min-h-0 bg-neutral-900 overflow-y-auto">
        <ArtistHeader imgUrl={imgUrl} color={HexPalette.DarkMuted} artist={artistData}/>
        <div 
            class="flex flex-1 min-h-0 flex-col gap-5 w-full h-full z-40 p-5"
            style={`background: linear-gradient(to top, #171717 87%, ${HexPalette.DarkMuted}80);`}
        >
            <ArtistActionsTracks client:visible topTracks={artistTopTracks.tracks}/>
            <ArtistDiscography>
                <ArtistAlbums client:visible artistDiscography={artistAlbums}/>
            </ArtistDiscography>
        </div>
    </div>
</MainLayout>

